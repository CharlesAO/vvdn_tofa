///
/// @file
/// @copyright All code copyright Movidius Ltd 2014, all rights reserved.
///            For License Warranty see: common/license.txt
///
/// @brief Dbyr filter unit test taken from c-model test
///        /debayertest/test.cpp
///

#include <sipp.h>
#include <sippTestCommon.h>

#if defined(SIPP_VCS)
#include <UnitTestApi.h>
#include <DrvTimer.h>
#include <DrvDdr.h>

#endif

#include "testHwDbyr.h"

/////////////////////////////////////////////////////
// Test specific macros
/////////////////////////////////////////////////////

#define SIPP_TEST_SYNC_API  // Set to use the synchronous API
//#define SIPP_USE_PRECALC_SCHEDULE

/////////////////////////////////////////////////////
// Global variables
/////////////////////////////////////////////////////

TestHwDbyr testDbyrPipe;

#ifndef SIPP_TEST_SYNC_API
volatile u32 testComplete = 0;
#endif

//12bit bayer
uint16_t iBuff12[] = {
  0x375,0x94c,0xb6c,0x282,0x65b,0x263,0x7fb,0x86a,0x9d4,0x0e8,0x25c,0x3eb,0x1cb,0xc42,0xe3e,0x518,0xd43,0xfc0,0x564,0xac0,0xe2a,0x2e7,0xcdb,0xd63,0xe25,0x743,0x82d,0xca8,0x904,0xafe,0xb37,0x03b,
  0x06d,0xe71,0xa52,0xf9d,0xc93,0xbfd,0x601,0x8b5,0x007,0x2f8,0x5a4,0x6c8,0x1c3,0x184,0xaa9,0xa7d,0xd3b,0x411,0xe1f,0x391,0x50d,0xd63,0x42e,0x5bb,0xefa,0x54e,0x673,0x74a,0xf7f,0x05b,0xe70,0x9b7,
  0x5c0,0x56f,0x6d0,0x5ab,0xe03,0x984,0xc24,0xd47,0xea0,0xada,0x648,0x40f,0x1cb,0xded,0xa1d,0xbdd,0x288,0x55c,0x204,0x50c,0xd5f,0x3d8,0x17b,0x5b5,0x2d5,0xa4f,0x020,0xbf5,0x2b4,0xeb3,0x8fe,0x987,
  0x0da,0xe30,0x6db,0x756,0xf65,0x2a5,0xc94,0xdb1,0x2d5,0x46f,0x385,0xd66,0x4d6,0x84e,0x0ca,0x6bb,0x588,0xbe1,0x748,0x91e,0x2df,0x31f,0xec7,0x8be,0xe6e,0x41c,0x2b6,0x262,0xc55,0xe66,0x3ff,0x8f1,
  0xf3f,0x5c4,0x3ce,0xf5a,0x589,0xedf,0x7af,0x47b,0x03b,0xd77,0xcbd,0x90e,0xd8b,0x87d,0x6e8,0x951,0x370,0x6e0,0x4b1,0x0c3,0xbd2,0x1b7,0xea9,0xda0,0x7f3,0xb2c,0x670,0xfb6,0xc93,0xf87,0xa55,0xa33,
  0x0bf,0x3e0,0xb88,0xe3b,0xee9,0xee5,0x383,0xbb8,0x7b9,0x8cd,0x55b,0xb4f,0x899,0x271,0xef9,0x6d7,0x1fe,0xda1,0x043,0x12f,0xc11,0x49e,0x94c,0xa96,0xf84,0x950,0xfa2,0xf76,0xdf3,0x079,0x476,0x458,
  0xcb5,0xf5b,0xc99,0x6ec,0x044,0xcf8,0xe5b,0x88d,0x185,0x8a6,0x3ba,0xee8,0xa10,0x862,0x715,0xadc,0x633,0x769,0x8e3,0xfff,0xb23,0xb30,0x479,0x057,0xaa7,0x770,0xb26,0xb75,0xc25,0xb8d,0xf2b,0xe02,
  0xa32,0x9ab,0xd65,0xa81,0x42f,0x449,0xc3e,0x5c5,0xa12,0xfcf,0xb0a,0xc78,0xdb5,0x3e4,0x529,0xb8a,0xe01,0xa81,0xafd,0xe6a,0xd52,0x209,0x697,0xc22,0x2bd,0x24d,0x5bd,0x2bd,0xdd9,0xba3,0xd58,0x738,
  0xb3c,0x166,0xe48,0x2db,0xdaf,0xf54,0xf78,0xd5a,0x20c,0x9ea,0x037,0x0f2,0xa5a,0x606,0xe43,0xaf8,0xd0d,0x22a,0x029,0x368,0xfc2,0xcdf,0x4ba,0x8d3,0x679,0x63b,0xe77,0xf83,0x196,0x7c4,0x4c6,0x236,
  0xafe,0xbbe,0x6c2,0xc58,0xdcb,0xd41,0xc23,0x109,0x14b,0xaae,0x9cf,0x306,0x830,0xe73,0x8d4,0x77a,0xc58,0xba6,0x9d4,0x4e5,0x785,0x760,0xba0,0xee8,0xe56,0x1e3,0x41a,0xc10,0xd8e,0x5c1,0x5e0,0xb3b,
  0xf03,0x500,0xd95,0xe7d,0xc26,0xe3c,0x6a5,0x1d9,0xcca,0x424,0xae7,0x793,0xa21,0x98c,0x9f7,0xaed,0xcff,0xa2c,0x6e3,0xfef,0x3b1,0xd12,0x3bc,0x396,0x40d,0xffc,0xd85,0x6b3,0x279,0x3d3,0xe83,0xf53,
  0xb65,0x80e,0xbf2,0x3a9,0x290,0x6db,0xd3f,0x6af,0xf9d,0x3e4,0x902,0x514,0xa26,0x588,0xdba,0x902,0xded,0x1ec,0x45b,0xfe1,0x279,0x830,0x03d,0x6d4,0xd09,0x80f,0xd17,0x4ac,0x164,0x937,0x7bd,0x22a,
  0xa0b,0xce6,0xb9b,0xfc1,0xba2,0xa78,0xc8d,0x1d7,0x6e7,0x754,0xcf8,0x60a,0x898,0xe91,0xa5e,0xc92,0x490,0xa0d,0x904,0x492,0x940,0x788,0x90e,0x069,0x7e1,0x630,0xf18,0x41b,0x48d,0xdcd,0xe96,0x2d9,
  0x4db,0xe15,0x00b,0x5dc,0x451,0xc8c,0xf0f,0x597,0x0ce,0x6e7,0xed8,0xa6f,0xe8c,0x1e4,0xea3,0x3e8,0x892,0x5a6,0xc14,0x787,0xfb1,0xb5a,0xfe4,0xbfc,0xccc,0x9bf,0x31c,0xcf1,0xb35,0x8b3,0x7d6,0xfb0,
  0x2ee,0x53e,0xa9a,0xcf5,0x082,0x914,0x7ac,0x7b9,0xe75,0x858,0xcd3,0x823,0x327,0x7ec,0xb0a,0xc10,0x28b,0x3c1,0x6d1,0x01b,0xdd3,0x933,0x03d,0x41f,0x114,0xb22,0x068,0x0d7,0x878,0x5eb,0xec9,0x90a,
  0x8ca,0xe93,0x9a5,0x395,0x2a3,0x3e7,0x73d,0x41c,0x8ef,0x7eb,0xd1e,0xa59,0x3f2,0x563,0x61d,0xb25,0xdbc,0x659,0x137,0x6b1,0xd21,0x6d0,0xa6a,0xc5f,0xd92,0x88a,0x55b,0xa24,0x522,0x2ee,0xf09,0x316,
};

// O buffer (Excel GOLD data for bilinear debayer)
uint16_t   eBuff12[3][SIPP_HW_DEBAYER_INPUT_BUFFER_WIDTH * SIPP_HW_DEBAYER_INPUT_BUFFER_HEIGHT] =
{
//Red
{2380,2380,1511,642,626,611,1382,2154,1193,232,617,1003,2070,3138,2221,1304,2668,4032,3392,2752,1747,743,2085,3427,2643,1859,2550,3240,3027,2814,1436,59,
 1885,1885,1466,1046,1285,1523,2150,2777,2141,1505,1263,1021,2186,3352,2761,2171,2436,2702,2362,2022,1443,863,1654,2444,2347,2249,2700,3151,3220,3289,2269,1249,
 1391,1391,1421,1451,1943,2436,2918,3399,3089,2778,1908,1039,2302,3565,3301,3037,2205,1372,1332,1292,1138,984,1222,1461,2050,2639,2850,3061,3412,3763,3101,2439,
 1433,1433,2062,2691,2906,3122,2697,2273,2693,3113,2396,1678,2274,2869,2790,2711,2138,1566,1155,743,727,711,1593,2475,2612,2750,3146,3542,3706,3869,3197,2525,
 1476,1476,2703,3930,3869,3807,2477,1147,2297,3447,2883,2318,2246,2173,2279,2385,2072,1760,977,195,317,439,1963,3488,3174,2860,3441,4022,3999,3975,3293,2611,
 2704,2704,2777,2851,3207,3564,2616,1668,2249,2831,2949,3067,2613,2160,2371,2583,2206,1828,1987,2145,1898,1651,1719,1787,2085,2382,2930,3478,3472,3466,3283,3099,
 3931,3931,2852,1772,2546,3320,2755,2189,2202,2214,3015,3816,2981,2146,2463,2780,2339,1897,2996,4095,3480,2864,1475,87,995,1904,2419,2933,2945,2957,3272,3586,
 2145,2145,1698,1251,2437,3622,3213,2804,2590,2376,2202,2029,1936,1844,2319,2794,2010,1225,1854,2484,2782,3080,2126,1173,1461,1749,2601,3452,2962,2473,2274,2076,
 358,358,544,731,2328,3924,3671,3418,2978,2538,1390,242,892,1542,2175,2808,1681,554,713,872,2083,3295,2777,2259,1927,1595,2783,3971,2980,1988,1277,566,
 819,819,1519,2220,3002,3784,2865,1945,1872,1799,1445,1090,1542,1993,2398,2803,2191,1579,2027,2476,2898,3321,2455,1588,2216,2844,2843,2843,2163,1483,1864,2245,
 1280,1280,2495,3709,3677,3644,2058,473,766,1060,1499,1939,2192,2444,2621,2797,2701,2604,3342,4079,3713,3346,2132,918,2505,4092,2904,1715,1347,979,2451,3923,
 2291,2291,3081,3871,3517,3162,1817,472,970,1468,1605,1742,2415,3087,3047,3008,2798,2589,2607,2625,2631,2637,1574,511,1675,2838,2110,1383,1819,2256,2291,2326,
 3302,3302,3668,4033,3357,2680,1575,471,1173,1876,1711,1546,2638,3729,3474,3218,2896,2573,1871,1170,1549,1928,1016,105,844,1584,1317,1051,2292,3533,2131,729,
 2322,2322,2999,3675,3089,2502,1863,1224,1615,2006,1910,1814,2347,2879,3016,3153,2460,1767,1183,598,1370,2142,1361,580,1398,2217,1425,633,1578,2524,2023,1521,
 1342,1342,2330,3317,2821,2324,2151,1977,2056,2136,2110,2083,2055,2028,2558,3088,2024,961,494,27,1191,2355,1705,1055,1952,2850,1532,215,865,1515,1914,2314,
 1342,1342,2330,3317,2821,2324,2151,1977,2056,2136,2110,2083,2055,2028,2558,3088,2024,961,494,27,1191,2355,1705,1055,1952,2850,1532,215,865,1515,1914,2314,   },

//Green
{885,2801,2924,3136,1627,2452,2043,2254,2516,1160,604,1133,459,1220,3646,3103,3395,1714,1380,1708,3626,3443,3291,2462,3621,2108,2093,2033,2308,1340,2871,2679,
 2438,3697,3091,3997,3070,3069,2612,2229,2312,760,1177,1736,760,388,2327,2685,1942,1041,962,913,2847,3427,2141,1467,1793,1358,1337,1866,1239,91,1938,2487,
 1472,2636,1744,2802,3587,2610,3108,3147,3744,1812,1608,1808,459,1390,2589,1911,648,1311,516,1796,3423,2007,379,1202,725,791,32,800,692,1693,2302,2345,
 3160,3632,2057,1878,1890,677,2314,3505,2111,1135,2359,3430,2371,2126,2051,1723,1573,3041,1773,2334,2396,799,1792,2238,1512,1052,835,610,2052,3686,2731,2289,
 3903,2375,974,1978,1417,1968,1967,2133,59,1677,3261,3264,3467,1996,1768,1530,880,2153,1201,1716,3026,2190,3753,2684,2035,1780,1648,2359,3219,2418,2645,2173,
 2285,992,2209,3643,2235,3813,3114,3000,1425,2253,2341,2895,2391,625,1489,1751,1927,3489,1817,303,1840,1182,2198,2710,2464,2384,2711,3958,2602,121,1940,1112,
 3253,2486,3225,2406,68,2163,3675,2135,389,1911,954,2404,2576,1502,1813,2026,1587,2510,2275,2280,2851,1425,1145,2422,2727,2139,2854,2656,3109,2523,3883,2682,
 2770,2475,3011,2689,1839,1097,2552,1477,1609,4047,2062,3192,2354,996,2354,2954,2643,2689,2174,3690,2774,521,1495,3106,2020,589,1962,701,1799,2979,2483,1848,
 2876,3003,3656,3252,3503,2988,3960,1556,524,1840,55,1668,2650,2749,3651,2965,3341,2263,41,2255,4034,1913,1210,2447,1657,1608,3703,1974,406,1520,1222,1792,
 3183,3006,3325,3160,3292,3393,2330,265,1699,2734,1588,774,2429,3699,2954,1914,2891,2982,1510,1253,2030,1888,1967,3816,1748,483,2684,3088,1400,1473,2321,2875,
 3843,3097,3477,2671,3110,2490,1701,1738,3274,2449,2791,1864,2593,2565,2551,2525,3327,2141,1763,2006,945,1471,956,1889,1037,1761,3461,2094,633,2045,3715,2715,
 2635,2062,2362,937,2195,1755,2095,1711,1937,996,2102,1300,1877,1416,2232,2306,1823,492,2157,4065,2369,2096,1779,1748,1716,2063,2646,1196,1338,2359,2591,554,
 2571,2802,2971,2096,2978,2790,3213,2030,1767,1962,3320,2373,2200,1688,2654,1782,1168,1353,2308,2667,2368,2422,2318,2288,2017,2610,3864,2385,1165,2371,3734,3010,
 2633,3605,2698,1500,1955,3212,2455,1431,2166,1767,2760,2671,1540,484,1741,1000,1066,1446,1856,1927,2685,2906,2088,3068,1964,2495,2444,3313,2218,2227,3441,4016,
 750,2700,2714,1315,130,1576,1964,2037,3701,2695,3283,2353,807,1374,2826,1832,651,1367,1745,2231,3539,2062,61,1643,276,1265,104,2045,2168,2233,3785,3094,
 2241,3731,2519,917,544,999,1495,1052,2620,2027,2811,2649,1410,1379,2471,2853,1445,1625,1707,1713,2634,1744,1258,3167,1476,2186,1247,2596,1920,750,2278,790,},

//Blue
{109,1375,2642,2931,3219,2378,1537,772,7,725,1444,947,451,1590,2729,3058,3387,3501,3615,2454,1293,1181,1070,2452,3834,2743,1651,2809,3967,3832,3696,3696,
 109,1375,2642,2931,3219,2378,1537,772,7,725,1444,947,451,1590,2729,3058,3387,3501,3615,2454,1293,1181,1070,2452,3834,2743,1651,2809,3967,3832,3696,3696,
 163,1181,2199,2889,3580,2979,2379,1372,366,769,1172,1008,844,1155,1465,1933,2402,2571,2740,1877,1014,1720,2427,3095,3764,2468,1172,2367,3562,2961,2360,2360,
 218,986,1755,2848,3941,3581,3220,1972,725,813,901,1069,1238,720,202,809,1416,1640,1864,1299,735,2259,3783,3739,3694,2194,694,1925,3157,2090,1023,1023,
 204,1279,2354,3116,3879,2969,2059,1705,1351,1243,1136,1428,1719,1868,2017,1490,963,964,965,1439,1912,2497,3082,3458,3833,3091,2348,2856,3364,2223,1082,1082,
 191,1571,2952,3385,3817,2358,899,1438,1977,1674,1371,1786,2201,3017,3833,2171,510,288,67,1578,3089,2735,2380,3176,3972,3987,4002,3787,3571,2357,1142,1142,
 1400,2296,3191,2817,2444,2230,2016,2147,2278,2188,2099,2477,2855,2716,2577,2312,2047,1744,1440,2345,3250,2642,2033,2185,2337,2536,2736,3147,3558,2919,2279,2279,
 2610,3020,3429,2250,1071,2103,3134,2856,2578,2702,2826,3168,3509,2415,1321,2453,3585,3199,2813,3112,3410,2549,1687,1194,701,1085,1469,2507,3545,3481,3416,3416,
 2712,2646,2580,2440,2301,2711,3121,2288,1454,2061,2669,2736,2803,2297,1790,2582,3373,3019,2665,2666,2668,2500,2332,2259,2186,1722,1259,2384,3508,2984,2460,2460,
 2814,2272,1730,2631,3531,3319,3107,1719,331,1421,2511,2304,2096,2178,2260,2710,3160,2838,2516,2221,1925,2451,2976,3323,3670,2360,1050,2260,3470,2487,1504,1504,
 2866,2630,2394,2244,2093,2671,3249,2707,2164,2286,2409,2378,2347,2617,2887,3125,3363,2589,1815,1547,1279,1399,1518,2511,3504,2852,2201,2057,1913,1828,1742,1742,
 2917,2988,3058,1857,656,2023,3391,3694,3997,3152,2306,2452,2598,3056,3514,3540,3565,2340,1115,874,633,347,61,1699,3337,3344,3351,1853,356,1168,1981,1981,
 2080,1807,1534,1207,880,2252,3623,2862,2101,2577,3053,3107,3161,3396,3631,3255,2880,2492,2104,2214,2325,2195,2064,2686,3307,2690,2074,1843,1612,1803,1993,1993,
 1243,627,11,558,1105,2480,3855,2030,206,2003,3800,3762,3724,3736,3747,2971,2194,2643,3092,3555,4017,4043,4068,3672,3276,2036,796,1832,2869,2438,2006,2006,
 1746,1493,1240,1065,890,1872,2854,2050,1246,2413,3579,2973,2367,2512,2656,2756,2855,2278,1701,2695,3689,3528,3367,3371,3375,2229,1083,1587,2092,2510,2928,2928,
 2250,2360,2469,1572,675,1264,1853,2070,2287,2823,3358,2184,1010,1287,1565,2541,3516,1913,311,1836,3361,3014,2666,3070,3474,2423,1371,1342,1314,2582,3849,3849, }
};

/////////////////////////////////////////////////////
// Function prototypes
/////////////////////////////////////////////////////

/////////////////////////////////////////////////////
// Code
/////////////////////////////////////////////////////

#ifdef SIPP_USE_PRECALC_SCHEDULE
#include "pcDumpSchedule.hh"
#endif



#ifndef SIPP_TEST_SYNC_API
void appSippCallback ( SippPipeline *             pPipeline,
                       eSIPP_PIPELINE_EVENT       eEvent,
                       SIPP_PIPELINE_EVENT_DATA * ptEventData
                     )
{
    if (eEvent == eSIPP_PIPELINE_FRAME_DONE)
    {
        printf ("appSippCallback : Frame done event received : Test proceeding to checks and termination\n");
        testComplete = 1;
    }

}

#endif


int main (int argc, char *argv[])
{
    UNUSED (argc);
    UNUSED (argv);
    u32    sippErrorLog[SIPP_ERROR_HISTORY_SIZE];

    sippPlatformInit ();

    #ifndef SIPP_PC
    if (PROCESS_LEON_OS == swcWhoAmI())
    {
        printf ("App Starting on LEON OS\n");

        #ifndef SIPP_TEST_SYNC_API
        printf ("Please make sure IRQ sources for dynamically route between LeonOS and LeonRT are set\n");
        #endif
    }
    else
    {
        printf ("App Starting on LEON RT\n");
    }
    #endif // SIPP_PC

    #ifndef SIPP_TEST_SYNC_API
    sippPlatformInitAsync ();
    #endif

    #ifdef SIPP_VCS
    unitTestInit();
    DrvTimerInit();
    DrvDdrInitialise(NULL);
    #endif

    buildTestHwDbyr(&testDbyrPipe);

    if (sippPipeGetErrorStatus (testDbyrPipe.pl))
    {
        u32 errNum;
        printf ("Pipeline creation error\nError codes:\n");
        errNum = sippGetErrorHistory (sippErrorLog);
        while (errNum)
        {
            printf ("%08lx\n", sippErrorLog[errNum - 0x1]);
            errNum--;
        }
    }

    #ifndef SIPP_TEST_SYNC_API
    // Register callback for async API
    sippRegisterEventCallback (testDbyrPipe.pl,
                               appSippCallback);
    #endif

    configTestHwDbyr(&testDbyrPipe);

    #ifdef SIPP_USE_PRECALC_SCHEDULE
    // Read offline schedule decisions
    dbgSchedInit(testDbyrPipe.pl);
    #endif

    #ifdef SIPP_TEST_SYNC_API
    sippProcessFrame(testDbyrPipe.pl);

    if (sippPipeGetErrorStatus (testDbyrPipe.pl))
    {
        u32 errNum;
        printf ("Pipeline runtime error\nError codes:\n");
        errNum = sippGetErrorHistory (sippErrorLog);
        while (errNum)
        {
            printf ("%08lx\n", sippErrorLog[errNum - 0x1]);
            errNum--;
        }
    }

    #else
    sippProcessFrameNB(testDbyrPipe.pl);

    if (sippPipeGetErrorStatus (testDbyrPipe.pl))
    {
        u32 errNum;
        printf ("Pipeline runtime error\nError codes:\n");
        errNum = sippGetErrorHistory (sippErrorLog);
        while (errNum)
        {
            printf ("%08lx\n", sippErrorLog[errNum - 0x1]);
            errNum--;
        }
    }

    while (testComplete == 0x0)
    {

    }
    #endif

    #ifdef  SIPP_PC
    sippGenericRuntimeWaitIsrThreadTerm ();
    #endif

    writeTestHwDbyrOutput(&testDbyrPipe);

    // Check the RGB output
    sippDbgCompareU8((u8*)eBuff12, (u8*)TestHwDbyr_dmaOut0_buffer,  SIPP_HW_DEBAYER_INPUT_BUFFER_SIZE * sizeof(u16));

    #ifdef SIPP_VCS
    unitTestFinalReport();
    #endif

   return 0;
}
